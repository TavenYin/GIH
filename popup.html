<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>GIH - Git Image Hosting</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/sweet-alert.min.css">
    <link rel="stylesheet" href="css/loaders.min.css">
    <link rel="stylesheet" href="css/popup.css">
</head>

<body>
    <div class="loading-bar"></div>
    <div class="loader-wrap text-center">
        <div class="loader-inner line-scale">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>
    <div class="container main">
        <div class="row">
            <input id="input" type="file" class="uploadTrigger" style="display:none;" accept="image/jpeg, image/png"
                multiple>
            <div class="col-xs-4 pull-left">
                <p style="padding-top:6px;margin-left:10px;">单击或者拖拽图片到此 | <a id="optionPage" href="setting.html">设置</a>
                </p>
            </div>
            <div class="col-xs-8" style="height: 45px;">
                <!-- <div class="btn-group" role="group">
                    <button type="button" class="btn btn-default btn-size" value="thumbnail">缩略图</button>
                    <button type="button" class="btn btn-default btn-size" value="mw690">中等尺寸</button>
                    <button type="button" class="btn btn-default btn-size active" value="large">原图</button>
                </div> -->
                <div class="btn-group" style="display:none" role="group">
                    <button type="button" class="btn btn-default btn-format  active" value="1">A</button>
                    <button type="button" class="btn btn-default btn-format" value="2">H</button>
                    <button type="button" class="btn btn-default btn-format" value="3">U</button>
                    <button type="button" class="btn btn-default btn-format" value="4">M</button>
                </div>
                <div class="pull-right" style="display:none">
                    <button type="button" class="btn btn-default btn-batchcopy" disabled>一键复制所有地址</button>
                </div>
            </div>
            <div class="col-xs-4 single-model">
                <figure>
                    <img src="img/placeholder.png" id="uploadPlaceHolder" class="dragger clicker">
                </figure>
                <span class="file-info"> <span id="fileName"></span> / <span id="fileSize"></span> </span>
                <br>
                <div id="single-progress" class="progress">
                    <div class="progress-bar progress-bar-info progress-bar-striped" role="progressbar"
                        aria-valuenow="20" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                        <span class="sr-only">20% Complete</span>
                    </div>
                </div>
            </div>
            <div class="col-xs-8 single-model">
                <div class="link-item">
                    <strong>图片链接<small class="muted">(试一试粘贴图片到这里↓)</small></strong>
                    <div class="input-append">
                        <input class="res col-xs-10" id="res_img" value="" spelcheck="false" />
                        <button type="button" class="btn btn-default btn-copy disabled">复制</button>
                    </div>
                </div>
                <div class="link-item">
                    <strong>HTML</strong>
                    <div class="input-append">
                        <input class="res col-xs-10" id="res_html" value="" spellcheck="false" readonly="true" />
                        <button type="button" class="btn btn-default btn-copy disabled">复制</button>
                    </div>
                </div>
                <div class="link-item">
                    <strong>UBB</strong>
                    <div class="input-append">
                        <input class="res col-xs-10" id="res_ubb" value="" spellcheck="false" readonly="true" />
                        <button type="button" class="btn btn-default btn-copy disabled">复制</button>
                    </div>
                </div>
                <div class="link-item">
                    <strong>Markdown</strong>
                    <div class="input-append">
                        <input class="res col-xs-10" id="res_md" value="" spellcheck="false" readonly="true" />
                        <button type="button" class="btn btn-default btn-copy disabled">复制</button>
                    </div>
                </div>
            </div>
            <div class="col-xs-12 batch-model">
                <div>
                    <img src="img/placeholder2.png" class="dragger clicker">
                </div>
            </div>
        </div>
        <div class="navbar-fixed-bottom">
            <div class="https col-xs-8">
                <!-- <span id="statusBadge" class="badge"> </span>
                <input id="https" type="checkbox"> <label id="https-label" for="https">HTTPS</label> -->
                <button class="btn btn-default  btn-batch" type="button" id="update">更新仓库</button>
            </div>
            <div class="col-xs-4">
                <button class="pull-right btn btn-default btn-batch" type="button">批量模式</button>
            </div>
        </div>
    </div>
    <script>
        window.nodeRequire = require;
        // delete window.require;
        delete window.exports;
        delete window.module;
    </script>
    <script src="./js/utils.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/sweet-alert.min.js"></script>
    <script src="js/command.js"></script>
    <script>
        const fs = require("fs");
        var path = require("path");
        var setting = JSON.parse(localStorage.getItem("setting"))
        if (setting == null) {
            location.href = './setting.html'
        }

        $("#update").on("click", function () {
            // git pull
            commandExec('git pull', setting.local_folder)
            alert('更新成功');
        })

        $('body').on('mouseenter', '.clicker', function () {
            var img_url = $(this).parent().nextAll().find('#res_img').data('url');

            if (img_url != '' && img_url != undefined && $(this).attr('data-url') != 1) {
                $(this).prop('src', img_url);
                $(this).attr('data-url', 1);
            }
        }).on("click", '.clicker', function () {
            $('#input').trigger('click');
        });

        $('#input').change(function () {
            var f = document.querySelector('#input');
            if (f.value != "") {
                var result = upload(f.files[0].path);

                // 异步执行git操作和渲染
                setTimeout(function () {
                    gitCommitAndPush(result.fileName)
                    render(result.url)
                }, 0)

                f.value = null;
            } else {
                alert('未选择图片哦')

            }
        })

        function upload(srcPath) {
            $(".loader-wrap").show();
            var prefix = uuid();
            var suffix = srcPath.substring(srcPath.indexOf("."));
            var targetFolder = setting.local_folder + fileSeparator() + setting.path;
            var fileName = prefix + suffix;
            var targetFile = targetFolder + fileSeparator() + fileName;
            mkdirsSyncIfNecessary(targetFolder)
            fs.writeFileSync(targetFile, fs.readFileSync(srcPath));
            return {
                "url":setting.rep_uri + "/raw/" + setting.label + "/" + setting.path + "/" + fileName,
                "fileName": fileName
            };
        }

        function render(result) {
            $("#res_img").val(result)
            $('#res_html').val('<img src="'+result+'"/>');
            $('#res_ubb').val('[IMG]'+result+'[/IMG]');
            $('#res_md').val('![]('+result+')');
            $('.single-model img').prop('src', '1x1.png');
            $('.single-model img').css('background-image', 'url(' + result + ')');
            $('.single-model img').css('border', 'none');
            $('.single-model img').css('background-position', 'center');
            $('.file-info').css('display', 'inline-block');
            $(".btn-copy").removeClass("disabled");
            $(".loader-wrap").hide();
        }

        function mkdirsSyncIfNecessary(dirname) {
            //console.log(dirname);  
            if (fs.existsSync(dirname)) {
                return true;
            } else {
                if (mkdirsSyncIfNecessary(path.dirname(dirname))) {
                    fs.mkdirSync(dirname);
                    return true;
                }
            }
        }

        // 拖拽
        document.querySelector("#uploadPlaceHolder").addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            var result = upload(e.dataTransfer.files[0].path);
            setTimeout(function () {
                gitCommitAndPush()
                render(result)
            }, 0)
            // for (const f of e.dataTransfer.files) {
            //     upload(f.path)
            // }
        });
        document.querySelector("#uploadPlaceHolder").addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
        });

        $(".btn-copy,.btn-batchcopy").hover(
            function () {
                $(this).removeAttr('data-tooltip');
            },
            function () {
                $(this).blur();
            }
        );
        //单图模式下的"复制"按钮,添加点击事件
        $(".btn-copy").on("click", function () {
            event.preventDefault();
            $(this).prev().select();
            var dataToCpy = $(this).prev().val();
            document.execCommand('copy');
            $(this).attr("data-tooltip", "复制成功"); //data-tooltip="复制成功"
            document.getSelection().removeAllRanges();
        });
    </script>
</body>

</html>